<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>PyTorch bindings - Darwin-py docs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "PyTorch bindings";
    var mkdocs_page_input_path = "torch.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/sh.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Darwin-py docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Darwin SDK and CLI</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../commandline/">Command line</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../library/">Library</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">PyTorch bindings</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#loading-a-dataset-in-python">Loading a dataset in Python</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#darwin-torchvision">Darwin &#x2715; Torchvision</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#darwin-detectron2">Darwin &#x2715; Detectron2</a>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Darwin-py docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>PyTorch bindings</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="pytorch-bindings">PyTorch bindings</h1>
<h2 id="loading-a-dataset-in-python">Loading a dataset in Python</h2>
<p>This module includes some functionality to import your datasets ready to be plugged into your Pytorch-based libraries. For this, you can use the function <code>get_dataset</code>:</p>
<pre><code>get_dataset(dataset_slug, dataset_type [, partition, split, split_type, transform])

Input
----------
dataset_slug: str
  Slug of the dataset to retrieve
dataset_type: str
  The type of dataset [classification, instance-segmentation, semantic-segmentation]
partition: str
  Selects one of the partitions [train, val, test, None]. (Default: None)
split: str
  Selects the split that defines the percentages used. (Default: 'default')
split_type: str
  Heuristic used to do the split [random, stratified]. (Default: 'random')
transform : list[torchvision.transforms]
  List of PyTorch transforms. (Default: None)

Output
----------
dataset: LocalDataset
  API class to the local dataset
</code></pre>

<p><strong>Note:</strong> For now, it only support three types of dataset: <code>classification</code>, <code>instance-segmentation</code>, and <code>semantic-segmentation</code>. These different modes use different API classes, which load and pre-process the data in different ways, suited for these specific tasks. If you need a different API or a different pre-processing for a different task you can take a look into the implementation of these APIs in <code>darwin.torch.dataset</code> and extend <code>LocalDataset</code> in the way it suits your needs best.</p>
<p>This is an example of how to load the <code>v7-demo/bird-species</code> dataset ready to be used in a instance segmentation task by using <code>"instance-segmentation"</code> as <code>dataset_type</code>. First, we will pull it from Darwin using <code>darwin-py</code>'s CLI, and will create train, validation, and test partitions:</p>
<pre><code class="bash">darwin dataset pull v7-demo/bird-species
darwin dataset split v7-demo/bird-species --val-percentage 10 --test-percentage 20
</code></pre>

<p>Once downloaded, we can use <code>get_dataset</code> to load the different partitions, and pass different transformations for train and validation splits (some basic transformations are implemented in <code>darwin.torch.transforms</code> but you can also use your own transformations):</p>
<pre><code class="python">from darwin.torch import get_dataset
import darwin.torch.transforms as T

dataset_slug = &quot;v7-demo/bird-species&quot;

trfs_train = T.Compose([T.RandomHorizontalFlip(), T.ToTensor()])
db_train = get_dataset(dataset_slug, dataset_type=&quot;instance-segmentation&quot;, \
    partition=&quot;train&quot;, split_type=&quot;stratified&quot;, transform=trfs_train)

trfs_val = T.ToTensor()
db_val = get_dataset(dataset_slug, dataset_type=&quot;instance-segmentation&quot;, \
    partition=&quot;val&quot;, split_type=&quot;stratified&quot;, transform=trfs_val)

print(db_train)
# Returns:
# InstanceSegmentationDataset():
#   Root: /datasets/v7-demo/bird-species
#   Number of images: 1336
#   Number of classes: 3
</code></pre>

<h2 id="darwin-torchvision">Darwin &#x2715; Torchvision</h2>
<p>This tutorial shows how to train an instance segmentaion model on a Darwin dataset using Pytorch's <a href="https://github.com/pytorch/vision">Torchvsion</a> and <code>darwin-py</code>. If you do not have Pytorch and Torchvision installed yet, you can follow these <a href="https://pytorch.org/get-started/locally/">installation instructions</a>.</p>
<p>First, using <code>darwin-py</code>'s CLI, we will pull the dataset from Darwin and create train, validation, and test partitions.</p>
<pre><code class="bash">darwin dataset pull v7-demo/bird-species
darwin dataset split v7-demo/bird-species --val-percentage 10 --test-percentage 20
</code></pre>

<p>Now, in Python, we will start by importing some <code>torchvision</code> and <code>darwin-py</code> functions, and by defining the function <code>get_instance_segmentation_model</code> that we will use to instantiate a <a href="https://arxiv.org/abs/1703.06870">Mask-RCNN</a> model using Torchvision's API.</p>
<pre><code class="python">import torch
import torchvision
from torchvision.models.detection.faster_rcnn import FastRCNNPredictor
from torchvision.models.detection.mask_rcnn import MaskRCNNPredictor

from darwin.torch import get_dataset
import darwin.torch.transforms as T


def collate_fn(batch):
    return tuple(zip(*batch))

def get_instance_segmentation_model(num_classes):
    # load an instance segmentation model pre-trained on COCO
    model = torchvision.models.detection.maskrcnn_resnet50_fpn(pretrained=True)

    # add a new bounding box predictor
    in_features = model.roi_heads.box_predictor.cls_score.in_features
    model.roi_heads.box_predictor = FastRCNNPredictor(in_features, num_classes)

    # add a new mask predictor
    in_features_mask = model.roi_heads.mask_predictor.conv5_mask.in_channels
    hidden_layer = 256
    model.roi_heads.mask_predictor = MaskRCNNPredictor(in_features_mask,
                                                       hidden_layer,
                                                       num_classes)
    return model
</code></pre>

<p>Then, we will load the dataset using <code>darwin-py</code>'s <code>get_dataset</code> function, specifying the dataset slug, the dataset type (in this case we need an <code>instance-segmentation</code> dataset), and the <code>train</code> partition. The dataset that we get back can be used directly into Pytorch's standard DataLoader.</p>
<pre><code class="python">trfs_train = T.Compose([T.RandomHorizontalFlip(), T.ToTensor()])
dataset = get_dataset(&quot;v7-demo/bird-species&quot;, dataset_type=&quot;instance-segmentation&quot;,
                      partition=&quot;train&quot;, split_type=&quot;stratified&quot;, transform=trfs_train)
data_loader = torch.utils.data.DataLoader(dataset, batch_size=2, shuffle=True, num_workers=4, collate_fn=collate_fn)
</code></pre>

<p>Next, we instantiate the instance segmentation model and define the optimizer and the learning rate scheduler.</p>
<pre><code class="python">device = torch.device('cuda') if torch.cuda.is_available() else torch.device('cpu')

# get the model using our helper function
num_classes = dataset.num_classes + 1 # number of classes in the dataset + background
model = get_instance_segmentation_model(num_classes)
model.to(device)

# construct an optimizer
params = [p for p in model.parameters() if p.requires_grad]
optimizer = torch.optim.SGD(params, lr=0.005, momentum=0.9, weight_decay=0.0005)
# and a learning rate scheduler
lr_scheduler = torch.optim.lr_scheduler.StepLR(optimizer, step_size=3, gamma=0.1)
</code></pre>

<p>And finally, we write our training loop and train the model for 10 full epochs.</p>
<pre><code class="python"># let's train it for 10 epochs
for epoch in range(10):
    # train for one epoch, printing every 10 iterations
    acumm_loss = 0
    for i, (images, targets) in enumerate(data_loader):
        images = list(image.to(device) for image in images)
        targets = [{k: v.to(device) for k, v in t.items() if isinstance(v, torch.Tensor)} for t in targets]

        loss_dict = model(images, targets)
        losses = sum(loss for loss in loss_dict.values())

        optimizer.zero_grad()
        losses.backward()
        optimizer.step()
        acumm_loss += losses.cpu().item()
        if i % 10 == 0:
            print(f&quot;Loss: {acumm_loss/10}&quot;)
            acumm_loss = 0

    lr_scheduler.step()
</code></pre>

<h2 id="darwin-detectron2">Darwin &#x2715; Detectron2</h2>
<p>This tutorial shows how to train <a href="https://github.com/facebookresearch/detectron2">Detectron2</a> models in your Darwin datasets. If you do not have Detectron2 installed yet, please follow these <a href="https://github.com/facebookresearch/detectron2/blob/master/INSTALL.md">installation instructions</a>.</p>
<p>Detectron2 organizes the datasets in <code>DatasetCatalog</code>, so the only thing we will need to do is to register our Darwin dataset in this catalog. For this, <code>darwin-py</code> provides the function <code>detectron2_register_dataset</code>, which takes the following parameters:</p>
<pre><code>detectron2_register_dataset(dataset_slug [, partition, split, split_type, release_name, evaluator_type])

Input
----------
dataset_slug: Path, str
  Slug of the dataset you want to register
partition: str
  Selects one of the partitions [train, val, test]. If None, loads the whole dataset. (default: None)
split
  Selects the split that defines the percetages used (use 'default' to select the default split)
split_type: str
  Heuristic used to do the split [random, stratified] (default: stratified)
release_name: str
  Version of the dataset. If None, takes the latest (default: None)
evaluator_type: str
  Evaluator to be used in the val and test sets (default: None)

Output
----------
catalog_name: str
  Name used to register this dataset partition in DatasetCatalog
</code></pre>

<p>Here's an example of how to use this function to register a Darwin dataset, and train an instance segmentation model on it. First, and as we did before, we will start by pulling the dataset from Darwin and splitting it into train and validation from the command line:</p>
<pre><code class="bash">darwin dataset pull v7-demo/bird-species
darwin dataset split v7-demo/bird-species --val-percentage 10 --test-percentage 20
</code></pre>

<p>Now, in Python, we will import some <code>detectron2</code> utils and we will register the Darwin dataset into Detectron2's catalog.</p>
<pre><code class="python">import os
# import some common Detectron2 and Darwin utilities
from detectron2.utils.logger import setup_logger
from detectron2 import model_zoo
from detectron2.engine import DefaultTrainer
from detectron2.config import get_cfg
from detectron2.data import MetadataCatalog, build_detection_test_loader
from detectron2.evaluation import COCOEvaluator, inference_on_dataset
from darwin.torch.utils import detectron2_register_dataset


# Register both training and validation sets
dataset_slug = 'v7-demo/bird-species'
dataset_train = detectron2_register_dataset(dataset_slug, partition='train', split_type='stratified')
dataset_val = detectron2_register_dataset(dataset_slug, partition='val', split_type='stratified')
</code></pre>

<p>Next, we will set up the model and the training configuration, and launch the training.</p>
<pre><code class="python"># Set up training configuration and train the model
cfg = get_cfg()
cfg.merge_from_file(model_zoo.get_config_file(&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;))
cfg.DATASETS.TRAIN = (dataset_train,)
cfg.DATASETS.TEST = ()
cfg.DATALOADER.NUM_WORKERS = 2
cfg.MODEL.WEIGHTS = model_zoo.get_checkpoint_url(&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;)
cfg.SOLVER.IMS_PER_BATCH = 8
cfg.SOLVER.BASE_LR = 0.005  # pick a good LR
cfg.SOLVER.MAX_ITER = 1000  # and a good number of iterations
cfg.MODEL.ROI_HEADS.NUM_CLASSES = len(MetadataCatalog.get(dataset_train).thing_classes)

# Instantiate the trainer and train the model
os.makedirs(cfg.OUTPUT_DIR, exist_ok=True)
trainer = DefaultTrainer(cfg)
trainer.resume_or_load(resume=False)
setup_logger()
trainer.train()
</code></pre>

<p>Finally, we will evaluate the model using the built-in COCO evaluator.</p>
<pre><code class="python"># Evaluate the model
cfg.MODEL.WEIGHTS = os.path.join(cfg.OUTPUT_DIR, &quot;model_final.pth&quot;)
cfg.DATASETS.TEST = (dataset_val, )
evaluator = COCOEvaluator(dataset_val, cfg, False, output_dir=&quot;./output/&quot;)
val_loader = build_detection_test_loader(cfg, dataset_val)
inference_on_dataset(trainer.model, val_loader, evaluator)
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../library/" class="btn btn-neutral" title="Library"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../library/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
